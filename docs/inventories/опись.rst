.. _`в справке`: https://www.diadoc.ru/docs/faq/faq-127
.. _`документы, представленные в виде скан-образа`: https://normativ.kontur.ru/document?moduleId=1&documentId=291280&rangeId=180910


Опись
============

Что такое опись
---------------

Опись — это XML-файл с перечислением документов, которые налогоплательщик отправляет в налоговый орган. Опись может быть направлена в ответ на требования с КНД 1165013 и 1165050. Также ее можно направить, чтобы представить документы к налоговой декларации.

Опись ссылается на требование, в ответ на которое она формируется, и включает список файлов, высылаемых в налоговую. Чтобы отправить опись и следить за документооборотом с налоговым органом, необходимо знать **идентификатор входящего документооборота и документа с типом fns534-demand-attachment в нем**.

*Почему обязательно создавать опись*? Если создадите новый документооборот (письмо) с набором документов, то в информационных системах ФНС они не будут связаны с требованием. Тогда не будет соблюдено требование законодательства по срокам ответа.

DraftsBuilder
-------------

Для формирования черновика и XML-файла описи мы создали помощник DraftsBuilder. Он строит шаблон из загруженных файлов, подписей контрагентов и сообщения о представительстве (доверенности) и собирает созданный шаблон в черновик. XML-файл описи будет состоять из списка документов с привязкой пункта требования, в документах будут перечислены файлы для налогового органа и подписи.

Замечание про подписи
    Существует два вида подписи: подпись контрагента, которая подкладывается к формализованным файлам, и подпись отправителя. Подпись контрагента нужно подписывать КЭП отправителя описи, так же как и остальные файлы черновика перед отправкой.   

.. image:: /inventories/structure.png

Замечание про документы и файлы
    Нужно разделять сущности документа и файла в DraftsBuilder. Документ является контейнером для файлов. Файл — это файл пользователя, который он отправляет в налоговый орган. Файлы могут быть формализованные и неформализованные, подробнее читайте `в справке`_.

В один документ-контейнер можно положить:

* один или несколько файлов одного неформализованного документа,
* формализованный файл и подпись контрагента,
* титульные страницы формализованного документа с подписями контрагента.

В DraftsBuilder можно положить файлы (`документы, представленные в виде скан-образа`_) с расширением: jpg, png, pdf, tif, tiff. Один черновик описи может содержать до 99 файлов и быть объемом не более 60 Мб. Если суммарный объем приложенных файлов будет больше 60 Мб, или пользователь приложит большее количество, DraftsBuilder сам разделит их на несколько черновиков. Черновики будут отправлены как *отдельные описи в отдельных документооборотах*. 


**Функции DraftsBuilder:**

* Приводит приложенные файлы к установленному ФНС формату.
* Разбивает файлы на черновики.
* Подкладывает в каждый черновик сообщение о представительстве, переданное налогоплательщиком.
* Задает документам уникальное название.
* Формирует XML-файл описи к каждой группе.

Процесс работы с описью
-----------------------

.. image:: /inventories/invent_proc.png

1. Создание DraftsBuilder методом :ref:`POST CreateDraftsBuilder<rst-markup-createDB>`

 Метод создает шаблон черновика описи: для этого нужно передать идентификаторы входящего документооборота и документа в нем, а также пункт требования. При создании важно заполнить метаинформацию.
 
 В результате метод вернет идентификатор созданного шаблона DraftsBuilder и все его содержимое. 
 
 Пункт требования можно прописать на весь DraftsBuilder — глобальный, а можно на конкретный документ — выборочный. Пункт требования в документе более приоритетный, но если он не заполнен, будет взято значение глобального параметра. 

2. Добавление документа :ref:`POST CreateDraftsBuilderDocument<rst-markup-createdocDB>`

 Чтобы добавить файлы, необходимо сначала добавить для них контейнер — документ. Вызываем столько раз, сколько отдельных документов-контейнеров нужно создать.

3. Добавление файла :ref:`POST CreateDraftsBuilderDocumentFile<rst-markup-createfileDB>`
 
 Метод создает файл в документе. Вызываем столько раз, сколько файлов нужно положить в документ-контейнер.

4. Сбор DraftsBuilder :ref:`POST BuildDrafts<rst-markup-buildDB>`

 Метод собирает все добавленные файлы и документы DraftsBuilder шаблона в черновики. В результате метод вернет идентификаторы черновиков, в каждом из которых находится: XML-файл описи, файлы, сообщение о представительстве (если есть).

Для редактирования содержимого DraftsBuilder смотри описание :doc:`методов DraftsBuilder</inventories/методы билдера>`.

5. Работа с черновиком. 
 Черновик описи проверяется, подписывается КЭП и отправляется при помощи методов :doc:`для работы с черновиками</drafts/index>`. После отправки черновика вы получите идентификатор документооборота.

6. После отправки описи необходимо отслеживать процесс документооборота и его статусы, для этого были реализованы :doc:`методы документооборота описи</inventories/методы до описи>`.

