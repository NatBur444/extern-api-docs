.. _`POST CreateDraftsBuilder`: https://developer.testkontur.ru/doc/extern/method?type=post&path=%2Fv1%2F%7BaccountId%7D%2Fdrafts%2Fbuilders
.. _`GET GetDraftsBuilder`: https://developer.testkontur.ru/doc/extern/method?type=get&path=%2Fv1%2F%7BaccountId%7D%2Fdrafts%2Fbuilders%2F%7BdraftsBuilderId%7D
.. _`GET GetDraftsBuilderMeta`: https://developer.testkontur.ru/doc/extern/method?type=get&path=%2Fv1%2F%7BaccountId%7D%2Fdrafts%2Fbuilders%2F%7BdraftsBuilderId%7D%2Fmeta
.. _`PUT UpdateDraftsBuilder`: https://developer.testkontur.ru/doc/extern/method?type=put&path=%2Fv1%2F%7BaccountId%7D%2Fdrafts%2Fbuilders%2F%7BdraftsBuilderId%7D
.. _`PUT UpdateDraftsBuilderMeta`: https://developer.testkontur.ru/doc/extern/method?type=put&path=%2Fv1%2F%7BaccountId%7D%2Fdrafts%2Fbuilders%2F%7BdraftsBuilderId%7D%2Fmeta
.. _`POST BuildDrafts`: https://developer.testkontur.ru/doc/extern/method?type=post&path=%2Fv1%2F%7BaccountId%7D%2Fdrafts%2Fbuilders%2F%7BdraftsBuilderId%7D%2Fbuild
.. _`GET GetBuildResult`: https://developer.testkontur.ru/doc/extern/method?type=get&path=%2Fv1%2F%7BaccountId%7D%2Fdrafts%2Fbuilders%2F%7BdraftsBuilderId%7D%2Ftasks%2F%7BapiTaskId%7D
.. _`DELETE RemoveDraftsBuilder`: https://developer.testkontur.ru/doc/extern/method?type=delete&path=%2Fv1%2F%7BaccountId%7D%2Fdrafts%2Fbuilders%2F%7BdraftsBuilderId%7D
.. _`GET GetDraftsBuilderDocuments`: https://developer.testkontur.ru/doc/extern/method?type=get&path=%2Fv1%2F%7BaccountId%7D%2Fdrafts%2Fbuilders%2F%7BdraftsBuilderId%7D%2Fdocuments
.. _`POST CreateDraftsBuilderDocument`: https://developer.testkontur.ru/doc/extern/method?type=post&path=%2Fv1%2F%7BaccountId%7D%2Fdrafts%2Fbuilders%2F%7BdraftsBuilderId%7D%2Fdocuments
.. _`GET GetDraftsBuilderDocument`: https://developer.testkontur.ru/doc/extern/method?type=get&path=%2Fv1%2F%7BaccountId%7D%2Fdrafts%2Fbuilders%2F%7BdraftsBuilderId%7D%2Fdocuments%2F%7BdocumentId%7D
.. _`GET GetDraftsBuilderDocumentMeta`: https://developer.testkontur.ru/doc/extern/method?type=get&path=%2Fv1%2F%7BaccountId%7D%2Fdrafts%2Fbuilders%2F%7BdraftsBuilderId%7D%2Fdocuments%2F%7BdocumentId%7D%2Fmeta
.. _`PUT UpdateDraftsBuilderDocument`: https://developer.testkontur.ru/doc/extern/method?type=put&path=%2Fv1%2F%7BaccountId%7D%2Fdrafts%2Fbuilders%2F%7BdraftsBuilderId%7D%2Fdocuments%2F%7BdocumentId%7D
.. _`PUT UpdateDraftsBuilderDocumentMeta`: https://developer.testkontur.ru/doc/extern/method?type=put&path=%2Fv1%2F%7BaccountId%7D%2Fdrafts%2Fbuilders%2F%7BdraftsBuilderId%7D%2Fdocuments%2F%7BdocumentId%7D%2Fmeta
.. _`DELETE RemoveDraftsBuilderDocument`: https://developer.testkontur.ru/doc/extern/method?type=delete&path=%2Fv1%2F%7BaccountId%7D%2Fdrafts%2Fbuilders%2F%7BdraftsBuilderId%7D%2Fdocuments%2F%7BdocumentId%7D
.. _`GET GetDraftsBuilderDocumentFiles`: https://developer.testkontur.ru/doc/extern/method?type=get&path=%2Fv1%2F%7BaccountId%7D%2Fdrafts%2Fbuilders%2F%7BdraftsBuilderId%7D%2Fdocuments%2F%7BdocumentId%7D%2Ffiles
.. _`POST CreateDraftsBuilderDocumentFile`: https://developer.testkontur.ru/doc/extern/method?type=post&path=%2Fv1%2F%7BaccountId%7D%2Fdrafts%2Fbuilders%2F%7BdraftsBuilderId%7D%2Fdocuments%2F%7BdocumentId%7D%2Ffiles
.. _`GET GetDraftsBuilderDocumentFile`: https://developer.testkontur.ru/doc/extern/method?type=get&path=%2Fv1%2F%7BaccountId%7D%2Fdrafts%2Fbuilders%2F%7BdraftsBuilderId%7D%2Fdocuments%2F%7BdocumentId%7D%2Ffiles%2F%7BfileId%7D
.. _`PUT UpdateDraftsBuilderDocumentFile`: https://developer.testkontur.ru/doc/extern/method?type=put&path=%2Fv1%2F%7BaccountId%7D%2Fdrafts%2Fbuilders%2F%7BdraftsBuilderId%7D%2Fdocuments%2F%7BdocumentId%7D%2Ffiles%2F%7BfileId%7D
.. _`GET GetDraftsBuilderDocumentFileContent`: https://developer.testkontur.ru/doc/extern/method?type=get&path=%2Fv1%2F%7BaccountId%7D%2Fdrafts%2Fbuilders%2F%7BdraftsBuilderId%7D%2Fdocuments%2F%7BdocumentId%7D%2Ffiles%2F%7BfileId%7D%2Fcontent
.. _`GET GetDraftsBuilderDocumentFileSignatureContent`: https://developer.testkontur.ru/doc/extern/method?type=get&path=%2Fv1%2F%7BaccountId%7D%2Fdrafts%2Fbuilders%2F%7BdraftsBuilderId%7D%2Fdocuments%2F%7BdocumentId%7D%2Ffiles%2F%7BfileId%7D%2Fsignature
.. _`GET GetDraftsBuilderDocumentFileMeta`: https://developer.testkontur.ru/doc/extern/method?type=get&path=%2Fv1%2F%7BaccountId%7D%2Fdrafts%2Fbuilders%2F%7BdraftsBuilderId%7D%2Fdocuments%2F%7BdocumentId%7D%2Ffiles%2F%7BfileId%7D%2Fmeta
.. _`PUT UpdateDraftsBuilderDocumentFileMeta`: https://developer.testkontur.ru/doc/extern/method?type=put&path=%2Fv1%2F%7BaccountId%7D%2Fdrafts%2Fbuilders%2F%7BdraftsBuilderId%7D%2Fdocuments%2F%7BdocumentId%7D%2Ffiles%2F%7BfileId%7D%2Fmeta
.. _`DELETE RemoveDraftsBuilderDocumentFile`: https://developer.testkontur.ru/doc/extern/method?type=delete&path=%2Fv1%2F%7BaccountId%7D%2Fdrafts%2Fbuilders%2F%7BdraftsBuilderId%7D%2Fdocuments%2F%7BdocumentId%7D%2Ffiles%2F%7BfileId%7D
.. _тут: https://www.diadoc.ru/docs/faq/faq-127

Методы для работы с DraftsBuilder
=================================

Подробная спецификация методов показана в Swagger в разделе DraftsBuilder.

.. contents:: Список доступных методов
   :depth: 2

.. _rst-markup-createDB:

Создание DraftsBuilder
----------------------

Метод: `POST CreateDraftsBuilder`_

Метод создает шаблон черновика. В результате метод вернет идентификатор созданного шаблона DraftsBuilder и все его содержимое. 

**Параметры Тела запроса** 

* ``Sender`` — информация об отправителе.
* ``Payer`` — информация о налогоплательщике, организации за которую отправляется отчет.
* ``Recipient`` — информация о получателе отчетности, налоговом органе.
* ``Builder-type`` — :doc:`тип DraftsBuilder</specification/типы DraftsBuilder>`.
* ``Builder-data``  — данные для указанного типа DraftsBuilder. Состав полей будет отличаться для каждого типа DraftsBuilder. 

*Builder-data для DraftsBuilder типа fns534-inventory*

* ``related-document`` — связанный документ (требование или письмо), на который формируется ответ:
   
   * ``related-docflow-id`` — идентификатор связанного документооборота.
   * ``related-document-id`` — идентификатор документа в связанном документообороте (требование или письмо).

*Builder-data для DraftsBuilder типа business-registration*

* ``registration-info`` — сведения для регистрации бизнеса:
   
   * ``application-code`` — код заявления по справочнику СФРД. Enums: р21001, р24001, р26001, р11001, р13001, р14001, р16001;
   * ``applicant-infos`` — информация о заявителе;
   * ``business-type`` — тип регистрируемого бизнеса. Enums: unknown, ip, ul;
   * ``ip-info`` — информация об ИП;
   * ``ul-info`` — информация о ЮЛ.

* ``paper-documents-delivery-type`` — признак наличия запроса о предоставлении документов отправителю в письменном (бумажном) виде. Enums:

   * ``ToApplicant`` — выдать документы лично заявителю;
   * ``ByPost`` — выслать документы по почте;
   * ``No`` — если не требуется предоставления документов в письменном (бумажном) виде.

* ``additional-certificates`` — список сертификатов подписантов, когда заявление подано от нескольких заявителей (для ЮЛ). Сертификат должен быть передан в формате base64. 

-  :download:`пример Request Body для создания DraftsBuilder Ответа на требование<../files/мета для создания DraftsBuilder типа inventory.json>`;

-  :download:`пример Request Body для создания DraftsBuilder для отчета в ПФР <../files/мета для создания DraftsBuilder типа pfr-report.json>`;

-  :download:`пример Request Body для создания DraftsBuilder для регистрации бизнеса <../files/мета для создания DraftsBuilder типа business-registration.json>`.

Получение DraftsBuilder
-----------------------

Метод: `GET GetDraftsBuilder`_

При помощи данного метода можно просмотреть содержимое созданного DraftsBuilder. Метод вернет метаинформацию и текущий статус DraftsBuilder (new, building, finished).

Получение метаинформации DraftsBuilder
---------------------------------------

Метод: `GET GetDraftsBuilderMeta`_

Метод возвращает только метаинформацию DraftsBuilder без статуса.

Редактирование DraftsBuilder
----------------------------

Метод: `PUT UpdateDraftsBuilder`_

Метод обновляет DraftsBuilder и его метаинформацию на переданные в запросе. Если DraftsBuilder с переданным draftsBuilderId не найден, метод создаст его. 

Редактирование метаинформации DraftsBuilder
--------------------------------------------

Метод: `PUT UpdateDraftsBuilderMeta`_

Метод обновляет метаинформацию DraftsBuilder.

.. _rst-markup-buildDB:

Сборка содержимого DraftsBuilder в черновик
-------------------------------------------

Метод: `POST BuildDrafts`_

Чтобы завершить создание черновика описи необходимо привести все переданные данные к установленному формату. 

В результате работы метод вернет:

* идентификаторы черновиков, в каждом из которых будет находиться: xml-файл описи, файлы, сообщение о представительстве (если есть);
* информацию о выполнении сборки, которая содержит: идентификатор TaskId, состояние сборки, результат, сообщение об ошибке. 

Время сборки зависит от количества и размера файлов, вы можете отслеживать состояние сборки черновиков по полученному идентификатору задачи TaskId и идентификатору DraftsBuilderId.

Проверка статуса сборки
-----------------------

Метод: `GET GetBuildResult`_

По переданным идентификаторам TaskId и DraftsBuilderId метод возвращает статус сборки. Когда сборка завершится, вы получите значение статуса равным succeed. Если в процессе хотя бы в одном документе произошла ошибка, статус сборки вернется также со значением succeed, а документ будет записан в список ошибочных (error-drafts-builder-documents). Идентификаторы сформированных без ошибок черновиков будут в списке draft-ids.

Удаление DraftsBuilder
----------------------

Метод: `DELETE RemoveDraftsBuilder`_

Метод удаляет DraftsBuilder и все его содержимое.

------------

Методы для работы с документами DraftsBuilder
=============================================

Получение списка документов
---------------------------

Метод: `GET GetDraftsBuilderDocuments`_

По идентификатору DraftsBuilderId метод находит список созданных в нем документов, для каждого возвращается: идентификатор документа, идентификатор DraftsBuilder, метаинформация.

.. _rst-markup-createdocDB:

Создание документа
------------------

Метод: `POST CreateDraftsBuilderDocument`_

Чтобы добавить файлы, необходимо сначала добавить для них контейнер — документ. Вызываем столько раз, сколько отдельных документов-контейнеров нужно создать.

**Параметры Тела запроса (Request Body)** 

 * ``meta`` — метаинформация документа:

   * ``Builder-type`` — тип DraftsBuilder;
   * ``Builder-data`` — данные для указанного типа DraftsBuilder. Состав полей будет отличаться для каждого типа DraftsBuilder. 

*Builder-data для DraftsBuilder типа fns534-inventory*

* ``claim-item-number`` — номер пункта требования, под которым документ указан в требовании в виде 1.ХХ или 2.ХХ;
* ``label-for-grouping`` — метка группы документов для разделения по разным описям;
* ``scanned-document-name`` — название отсканированного документа;
* ``type`` — тип документа. Enums: formalized, scanned, warrant;
* ``background-processing`` — условия для немедленной обработки документа:

   * ``total-file-count`` — указание количества файлов в документе. Когда в документ будет добавлено указанное количество файлов, начнется обработка этого документа. Это позволяет перенести шаг подготовки документа на этап загрузки других документов, что существенно ускоряет сборку черновиков при большом количестве документов.
   
      При указании этого параметра документ и его файлы будут заблокированы для изменений!
   
      Рекомендуется выставлять, если клиент уверен, что документ уже не будет изменен до запуска сборки DraftsBuilder в черновики. Если хотя бы один документ был подготовлен с неправильными данными, то нужно будет пересоздать DraftsBuilder целиком.

*Builder-data для DraftsBuilder типа business-registration*

* ``svdreg-code`` — код СВДРЕГ;
* ``signers`` — данные каждого подписанта.

-  :download:`Пример Request Body для создания документа в DraftsBuilder типа fns534-inventory<../files/мета для создания DraftsBuilderDocument типа fns534-inventory.json>`;

-  :download:`Пример Request Body для создания документа в DraftsBuilder типа business-registration<../files/мета для создания DraftsBuilderDocument типа business-registration.json>`;

Получение информации о документе
--------------------------------

Метод: `GET GetDraftsBuilderDocument`_

Метод возвращает всю информацию о документе по его идентификатору.

Получение метаинформации документа
-----------------------------------

Метод: `GET GetDraftsBuilderDocumentMeta`_

Метод возвращает метаинформацию документа по его идентификатору. 

Редактирование документа
------------------------

Метод: `PUT UpdateDraftsBuilderDocument`_

Метод обновляет документ и его метаинформацию на переданные в запросе. Если документ с переданным documentId в DraftBuilder не найден, метод создаст его. 

Редактирование метаинформации документа
----------------------------------------

Метод: `PUT UpdateDraftsBuilderDocumentMeta`_

Метод обновляет метаинформацию документа.  

Удаление документа в DraftBuilder
---------------------------------

Метод: `DELETE RemoveDraftsBuilderDocument`_

Удаляет документ по его идентификатору в заданном DraftBuilder.

-------

Методы для работы с файлами
===========================

Получение списка всех файлов документа
--------------------------------------

Метод: `GET GetDraftsBuilderDocumentFiles`_

По идентификатору DraftsBuilder и документу в нем метод находит список добавленных файлов.

.. _rst-markup-createfileDB:

Создание файла в документе
--------------------------

Метод: `POST CreateDraftsBuilderDocumentFile`_

Метод создает файл в документе. Вызываем столько раз, сколько файлов нужно положить в документ-контейнер.

*Пример метаинформации для создания файла в DraftsBuilder типа fns534-inventory*:

::

   {
      "file-name": "Имя документа.pdf",
      "builder-type": "urn:drafts-builder:fns534-inventory",
      "builder-data": {
         "scanned-file-order": "1"
      }
   }

*Пример метаинформации для создания файла в DraftsBuilder типа business-registration*:

::

   {
      "FileName": "AnyFileName.pdf",
      "builder-type": "urn:drafts-builder:business-registration",
      "BuilderData": null
   }

Получение файла по идентификатору
---------------------------------

Метод: `GET GetDraftsBuilderDocumentFile`_

Метод возвращает всю информацию о файле по его идентификатору.

Редактирование файла в документе
--------------------------------

Метод: `PUT UpdateDraftsBuilderDocumentFile`_

Метод обновляет файл и подпись в документе на переданные в запросе. Если файл с переданным fileId в документе не найден, метод создаст его. 

Получение содержимого файла
---------------------------

Метод: `GET GetDraftsBuilderDocumentFileContent`_

Метод возвращает содержимое файла в формате base64.

Получение подписи к файлу
-------------------------

Метод: `GET GetDraftsBuilderDocumentFileSignatureContent`_

Метод возвращает подпись контрагента, если она была приложена к файлу, в формате base64.

Получение метаинформации файла
------------------------------

Метод: `GET GetDraftsBuilderDocumentFileMeta`_

Метод возвращает метаинформацию файла.

Редактирование меты файла
-------------------------

Метод: `PUT UpdateDraftsBuilderDocumentFileMeta`_

Метод обновляет метаинформацию файла.

Удаление файла документа
------------------------

Метод: `DELETE RemoveDraftsBuilderDocumentFile`_

Метод удаляет файл в документе DraftsBilder по его идентификатору. 

