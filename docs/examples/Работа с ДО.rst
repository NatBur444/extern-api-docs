.. _`GET Docflow`: http://extern-api.testkontur.ru/swagger/ui/index#!/Docflows/Docflows_GetDocflowAsync
.. _`GET Docflows`: http://extern-api.testkontur.ru/swagger/ui/index#!/Docflows/Docflows_GetDocflowsAsync
.. _`GET ReplyDocument`: http://extern-api.testkontur.ru/swagger/ui/index#!/Docflows/Docflows_GetReplyDocumentAsync
.. _`POST ReplyDocument`: http://extern-api.testkontur.ru/swagger/ui/index#!/Docflows/Docflows_SendReplyDocumentAsync
.. _`POST DocumentPrint`: http://extern-api.testkontur.ru/swagger/ui/index#!/Docflows/Docflows_GetDocumentPrintAsync

Пример работы с документооборотом
=================================

После отправки черновика мы получаем идентификатор документооборота (id). В этом примере рассмотрим, как по id получить документооборот и работать с ним дальше. Пример касается документооборота ФНС типа Декларация.

Порядок работы
--------------

Ниже представлена схема прохождения данного типа документооборота

.. image:: /_static/dc_example4.jpg

1. Запрашиваем статус документооборота. Это можно делать двумя способами: запрашивать периодически конкретный документооборот, запомнив его id при отправке черновика, запрашивать список документооборотов своей учетной записи (предпочтительный вариант):

      * статус "Отправлен" означает, что изменений в документообороте после отправке черновика ещё не произошло, никаких действий не требуется
      * статус "Доставлен" означает, что документ дошел до ФНС и принят в работу, в документообороте при этом появится новый документ извещение о получении, никаких действий не требуется
      * статус "Ответ обработан" означает, что на отправленный документооборот пришли результаты приема.  
2. Получили результаты приема, формируем извещения о получении на них:

      * пришло уведомление об отказе, на него необходимо в ответ в инспекцию направить извещение о получении; после этого документооборот считается **завершенным**; отправленный документ ФНС не приняла; необходимо прочитать причины отказа в уведомлении, исправить их и отправить документ заново, создав новый черновик.  
      * пришла квитанция о приеме, на неё необходимо в ответ в инспекцию направить извещение о получении; отправленный документ ФНС приняла и приступила к его проверке.  
3. Вновь запрашиваем статус документооборота, и ждем его изменения на "Получен ответ"  

4. Статус "Получен ответ" означает, что на документ пришли результаты обработки: либо извещение о вводе, либо уведомление об уточнении. На них необходимо в ответ в инспекцию направить извещение о получении. После этого документооборот считается завершенным. Если пришло уведомление об уточнении, то необходимо исправить недочеты, указанные в уведомлении, исправить их и отправить корректировку, создав новый черновик.

По сути вся работа с документооборотом сводится к двум моментам:

* следить за статусом незавершенных документооборотов;
* при необходимости отправлять ответные документы.

1. Запрашиваем статус документооборота
--------------------------------------

Данный процесс можно организовать двумя методами:

* Метод: `GET Docflow`_ 

В цикле запрашиваем документооборот, оптимальным периодом запроса можно считать 1 час, изменения в документообороте не происходят часто. В результате работы метода содержится вся актуальная информация по документообороту, в том числе и его статус.

**Запрос**: 

.. code-block:: http

   GET /v1/ea3a9316-d3c5-4544-a6df-4e8d9aa9f813/docflows/520e9bec-90b3-4d35-ab18-240ee2c72df3 HTTP/1.1
   Authorization: auth.sid AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
   X-Kontur-Apikey: AAAAAAAA-AAAA-AAAA-AAAA-AAAAAAAAAA
   Content-Type: application/json
   Host: extern-api.testkontur.ru
   Connection: keep-alive



* Метод: `GET Docflows`_

В результате работы этого метода мы получаем список всех документооборотов учетной записи, у каждого документооборота в списке будет мета-информация о нем, в том числе и его статус. А можно заранее, задав фильтр в списке по статусу, выбирать документообороты только нужного статуса. В примере я для краткости списка выбрал только фильтр *take=3*, то есть взял 3 последних документооборота учетной записи. И если в списке будет видно изменение статуса, то можно запрашивать документооборот, чей статус изменился с помощью предыдущего метода GET Docflow и работать с ним дальше.

**Запрос**: 

.. code-block:: http

   GET /v1/ea3a9316-d3c5-4544-a6df-4e8d9aa9f813/docflows?take=3 HTTP/1.1
   Authorization: auth.sid AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
   X-Kontur-Apikey: AAAAAAAA-AAAA-AAAA-AAAA-AAAAAAAAAA
   Content-Type: application/json
   Host: extern-api.testkontur.ru
   Connection: keep-alive


2. Формирование извещения о получении на результаты приема
----------------------------------------------------------

Для этого необходимо воспользоваться последовательностью методов: ``GET ReplyDocument`` и ``POST ReplyDocument``.

Сначала с помощью метода ``GET ReplyDocument`` (в теле передаем контент сертификата) получаем xml-файл и печатную форму извещения о получении, подписываем его и методом ``POST ReplyDocument`` отправляем в ФНС: в ответе ``GET ReplyDocument`` будет нужная ссылка для отправки.

* Метод: `GET ReplyDocument`_

**Запрос**: 

.. code-block:: http

   POST /v1/ea3a9316-d3c5-4544-a6df-4e8d9aa9f813/docflows/520e9bec-90b3-4d35-ab18-240ee2c72df3/documents/3bd9e2ba-9273-4e21-ae56-      c7eb4aa17538/reply/fns534-report-receipt/generate HTTP/1.1
   Authorization: auth.sid AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
   X-Kontur-Apikey: AAAAAAAA-AAAA-AAAA-AAAA-AAAAAAAAAA
   Content-Type: application/json
   Host: extern-api.testkontur.ru
   Content-length: 3316
   Connection: keep-alive
   
   {
	   "certificate-base64": MIIJszCCCWKgAw ... NrZxycuX
   }


* Метод: `POST ReplyDocument`_

**Запрос**:

.. code-block:: http

   POST /v1/ea3a9316-d3c5-4544-a6df-4e8d9aa9f813/docflows/520e9bec-90b3-4d35-ab18-240ee2c72df3/documents/3bd9e2ba-9273-4e21-ae56-c7eb4aa17538/reply/fns534-report-receipt/send HTTP/1.1
   Authorization: auth.sid AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
   X-Kontur-Apikey: AAAAAAAA-AAAA-AAAA-AAAA-AAAAAAAAAA
   Content-Type: application/json
   Host: extern-api.testkontur.ru
   Content-length: 87214
   Connection: keep-alive
   
   {
     "id": "97096b8a-9a45-44af-873c-f4f3f6e18293",
     "content": "PD94bWwgdmVyc2 ... Pg0KPC/U4OnrPg==",
     "print-form-content": "JVBERi0xLjQKJdPr6eEKM ... 8gMSAwIFI+PgpzdGFydHhyZWYKNTc0MjYKJSVFT0Y=",
     "filename": "IZ_KVNOSRCHIS_0087_0087_3782868692378750338_20180411_51f5c29eb1b44e7399f5c3b3bac0c37e.xml",
     "signature": {
		   "id": "00000000-0000-0000-0000-000000000000",
   		"content-data": "MIIN8QYJKoZIhvcNAQcCoIIN4jCCDd4CAQEx ... Wg1AR2LO7hdfgy3H6AAsOzzF2epQn"
	   },
     "sender-ip": "8.8.8.8.",
     "links": [
       {
         "rel": "self",
         "href": "http://extern-api.testkontur.ru/v1/ea3a9316-d3c5-4544-a6df-4e8d9aa9f813/docflows/520e9bec-90b3-4d35-ab18-240ee2c72df3/documents/3bd9e2ba-9273-4e21-ae56-c7eb4aa17538/reply/fns534-report-receipt/generate"
       },
       {
         "rel": "docflow",
         "href": "http://extern-api.testkontur.ru/v1/ea3a9316-d3c5-4544-a6df-4e8d9aa9f813/docflows/520e9bec-90b3-4d35-ab18-240ee2c72df3"
       },
       {
         "rel": "send",
         "href": "http://extern-api.testkontur.ru/v1/ea3a9316-d3c5-4544-a6df-4e8d9aa9f813/docflows/520e9bec-90b3-4d35-ab18-240ee2c72df3/documents/3bd9e2ba-9273-4e21-ae56-c7eb4aa17538/reply/fns534-report-receipt/send"
       }
     ]
   }



3. Ожидание результатов обработки
---------------------------------

Работаем аналогично п.1.

4. Формирование извещения о получении на результаты обработки
-------------------------------------------------------------

Работаем аналогично п.2

Примечание
----------

* Статусы необязательно могут меняться строго последовательно. В примере выше мы запросили документооборот уже после того, как от ФНС пришли и результаты приема, и результаты обработки. Поэтому у нас сразу есть ссылки на формирование извещение о получении результата приема и результата обработки
* Среди ссылок с типом *reply* есть третья ссылка, она ведет на формирование извещения о получении подтверждения даты отправки, это технологический документ, им вы сообщаете нам о получении вами подтверждения даты отправки

Печать документов
-----------------

Метод: `POST DocumentPrint`_ 

Также в любой момент времени можно получить печатную форму любого формализованного документа в документообороте. В теле запроса передается контент печатаемого документа в base64. При чем во время печати мы проверим переданный на печать документ на соответствие подписи этого документа в документообороте. Если на печать передали контент измененного документа, то вернется ошибка.

