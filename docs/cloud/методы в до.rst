.. _`POST SignReplyDocument`: http://extern-api.testkontur.ru/swagger/ui/index#!/105210771090108610761099321076108311033210881072107310861090109932108932107610861082109110841077108510901086108610731086108810861090107210841080/DocflowReplyDocument_SignReplyDocumentAsync
.. _`GET GetDocflowDocumentTask`: http://extern-api.testkontur.ru/swagger/ui/index#!/105210771090108610761099321076108311033210881072107310861090109932108932107610861082109110841077108510901086108610731086108810861090107210841080/Docflows_GetDocflowDocumentTask
.. _`GET GetDocumentSignature`: http://extern-api.testkontur.ru/swagger/ui/index#!/105210771090108610761099321076108311033210881072107310861090109932108932107610861082109110841077108510901086108610731086108810861090107210841080/Docflows_GetDocumentSignatureAsync
.. _`POST DecryptDocument`: http://extern-api.testkontur.ru/swagger/ui/index#!/105210771090108610761099321076108311033210881072107310861090109932108932107610861082109110841077108510901086108610731086108810861090107210841080/Docflows_DecryptDocumentAsync

Подписание и дешифрование документов в документообороте
=====================

Процесс работы с API для подписания ответного документа
~~~~~~~~~~~~~~~~~~~~

 1. Подписание ответного документа `POST SignReplyDocument`_
    В данном методе проверяется тип сертификата пользователя. Если пользователь использует DSS сертификат, то в результате метод вернет модель SignInitResult с заполненными полями TaskId, ConfirmType = myDSS. Это означает, что сервис переходит в режим ожидания ответа от сервера КриптоПро DSS с результатом операции.

 2. Клиент на своем телефоне в приложении myDSS вводит ПИН-код от своей облачной ЭП и подтверждает, что он действительно хочет подписать документ;
 3. Проверка статуса задачи подписания документа методом `GET GetDocflowDocumentTask`_

    * Если состояние task-state = failed, это означает, что на любом этапе подписания возникла ошибка. Описание будет в модели Error.
    * Если состояние task-state = running, это означает, что подпись еще не подтверждена либо еще генерируется.
    * Если состояние task-state = succeed, это означает, что подписание завершено. Файл подписи был успешно сформирован и сохранен в черновике.

 4. Получить подпись `GET GetDocumentSignature`_

.. note::
   Подпись автоматически не будет приложена к ответному документу, пока на метод `GET GetDocflowDocumentTask`_ не будет получено состояние succeed. Мы работаем над автоматизацией процесса.

Процесс работы с API для дешифрования контента документа
~~~~~~~~~~~~~~~~~~~~

 1. Дешифрование содержимого документа `POST DecryptDocument`_
    В данном методе проверяется тип сертификата пользователя. Если пользователь использует DSS сертификат, то в результате метод вернет модель DecryptionInitResult с заполненными полями TaskId, ConfirmType = myDSS. Это означает, что сервис переходит в режим ожидания ответа от сервера КриптоПро DSS с результатом операции.

 2. Клиент на своем телефоне в приложении myDSS вводит ПИН-код от своей облачной ЭП и подтверждает, что он действительно хочет подписать документ;
 3. Проверка статуса задачи дешифрования `GET GetDocflowDocumentTask`_
    * Если состояние task-state = failed, это означает, что на любом этапе дешифрования возникла ошибка. Описание будет в модели Error.
    * Если состояние task-state = running, это означает, что дешифрование еще не подтверждено либо содержимое еще генерируется. 
    * Если состояние task-state = succeed, это означает, что дешифрование завершено. **В task-result будет лежать расшифрованный контент документа**.  